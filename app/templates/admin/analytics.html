{% extends "base.html" %}

{% block title %}{{ _('Analytics') }} - {{ _('Admin Panel') }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ _('Analytics Dashboard') }}</h1>
                    <p class="text-gray-600 mt-1">{{ _('Comprehensive insights and metrics') }}</p>
                </div>
                <div class="flex space-x-2">
                    <select id="timeRange"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="7">{{ _('Last 7 days') }}</option>
                        <option value="30" selected>{{ _('Last 30 days') }}</option>
                        <option value="90">{{ _('Last 90 days') }}</option>
                        <option value="365">{{ _('Last year') }}</option>
                    </select>
                    <button onclick="exportReport()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>{{ _('Export Report') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-ticket-alt text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">{{ _('Total Complaints') }}</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalComplaintsMetric">0</p>
                        <p class="text-sm text-green-600" id="complaintsChange">+0%</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">{{ _('Resolution Rate') }}</p>
                        <p class="text-2xl font-semibold text-gray-900" id="resolutionRate">0%</p>
                        <p class="text-sm text-green-600" id="resolutionChange">+0%</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">{{ _('Avg. Response Time') }}</p>
                        <p class="text-2xl font-semibold text-gray-900" id="avgResponseTime">0h</p>
                        <p class="text-sm text-red-600" id="responseTimeChange">+0%</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-star text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">{{ _('Customer Satisfaction') }}</p>
                        <p class="text-2xl font-semibold text-gray-900" id="customerSatisfaction">0.0</p>
                        <p class="text-sm text-green-600" id="satisfactionChange">+0%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Complaints Over Time -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">{{ _('Complaints Over Time') }}</h3>
                    <div class="flex space-x-2">
                        <button onclick="updateChart('complaints', 'daily')"
                            class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded-md">{{ _('Daily') }}</button>
                        <button onclick="updateChart('complaints', 'weekly')"
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-md">{{ _('Weekly') }}</button>
                        <button onclick="updateChart('complaints', 'monthly')"
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-md">{{ _('Monthly') }}</button>
                    </div>
                </div>
                <canvas id="complaintsChart" height="300"></canvas>
            </div>

            <!-- Status Distribution -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Status Distribution') }}</h3>
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Category Breakdown -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Category Breakdown') }}</h3>
                <canvas id="categoryChart" height="300"></canvas>
            </div>

            <!-- Priority Distribution -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Priority Distribution') }}</h3>
                <canvas id="priorityChart" height="300"></canvas>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Response Time Trend -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Response Time Trend') }}</h3>
                <canvas id="responseTimeChart" height="200"></canvas>
            </div>

            <!-- Resolution Time Trend -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Resolution Time Trend') }}</h3>
                <canvas id="resolutionTimeChart" height="200"></canvas>
            </div>

            <!-- Customer Satisfaction Trend -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Satisfaction Trend') }}</h3>
                <canvas id="satisfactionChart" height="200"></canvas>
            </div>
        </div>

        <!-- Detailed Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Top Issues -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Top Issues') }}</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Issue') }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Count') }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Trend') }}</th>
                            </tr>
                        </thead>
                        <tbody id="topIssuesTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agent Performance -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ _('Agent Performance') }}</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Agent') }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Resolved') }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ _('Avg
                                    Time') }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{
                                    _('Rating') }}</th>
                            </tr>
                        </thead>
                        <tbody id="agentPerformanceTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let charts = {};
    let currentTimeRange = 30;

    document.addEventListener('DOMContentLoaded', function () {
        loadAnalytics();

        // Time range change handler
        document.getElementById('timeRange').addEventListener('change', function () {
            currentTimeRange = this.value;
            loadAnalytics();
        });
    });

    function loadAnalytics() {
        const timeRange = document.getElementById('timeRange').value;

        // Load key metrics
        fetch(`/admin/api/analytics/metrics?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateKeyMetrics(data.metrics);
                }
            });

        // Load chart data
        loadChartData();

        // Load tables
        loadTopIssues();
        loadAgentPerformance();
    }

    function updateKeyMetrics(metrics) {
        document.getElementById('totalComplaintsMetric').textContent = metrics.total_complaints;
        document.getElementById('complaintsChange').textContent = `${metrics.complaints_change > 0 ? '+' : ''}${metrics.complaints_change}%`;
        document.getElementById('complaintsChange').className = `text-sm ${metrics.complaints_change >= 0 ? 'text-green-600' : 'text-red-600'}`;

        document.getElementById('resolutionRate').textContent = `${metrics.resolution_rate}%`;
        document.getElementById('resolutionChange').textContent = `${metrics.resolution_change > 0 ? '+' : ''}${metrics.resolution_change}%`;
        document.getElementById('resolutionChange').className = `text-sm ${metrics.resolution_change >= 0 ? 'text-green-600' : 'text-red-600'}`;

        document.getElementById('avgResponseTime').textContent = `${metrics.avg_response_time}h`;
        document.getElementById('responseTimeChange').textContent = `${metrics.response_time_change > 0 ? '+' : ''}${metrics.response_time_change}%`;
        document.getElementById('responseTimeChange').className = `text-sm ${metrics.response_time_change <= 0 ? 'text-green-600' : 'text-red-600'}`;

        document.getElementById('customerSatisfaction').textContent = metrics.customer_satisfaction.toFixed(1);
        document.getElementById('satisfactionChange').textContent = `${metrics.satisfaction_change > 0 ? '+' : ''}${metrics.satisfaction_change}%`;
        document.getElementById('satisfactionChange').className = `text-sm ${metrics.satisfaction_change >= 0 ? 'text-green-600' : 'text-red-600'}`;
    }

    function loadChartData() {
        const timeRange = document.getElementById('timeRange').value;

        // Complaints over time
        fetch(`/admin/api/analytics/complaints-trend?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createComplaintsChart(data.data);
                }
            });

        // Status distribution
        fetch(`/admin/api/analytics/status-distribution?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createStatusChart(data.data);
                }
            });

        // Category breakdown
        fetch(`/admin/api/analytics/category-breakdown?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createCategoryChart(data.data);
                }
            });

        // Priority distribution
        fetch(`/admin/api/analytics/priority-distribution?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createPriorityChart(data.data);
                }
            });

        // Performance trends
        loadPerformanceTrends();
    }

    function createComplaintsChart(data) {
        const ctx = document.getElementById('complaintsChart').getContext('2d');

        if (charts.complaints) {
            charts.complaints.destroy();
        }

        charts.complaints = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ _("Complaints") }}',
                    data: data.values,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createStatusChart(data) {
        const ctx = document.getElementById('statusChart').getContext('2d');

        if (charts.status) {
            charts.status.destroy();
        }

        charts.status = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: [
                        '#fbbf24', // pending - yellow
                        '#3b82f6', // in_progress - blue
                        '#10b981', // resolved - green
                        '#6b7280'  // closed - gray
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    function createCategoryChart(data) {
        const ctx = document.getElementById('categoryChart').getContext('2d');

        if (charts.category) {
            charts.category.destroy();
        }

        charts.category = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ _("Complaints") }}',
                    data: data.values,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createPriorityChart(data) {
        const ctx = document.getElementById('priorityChart').getContext('2d');

        if (charts.priority) {
            charts.priority.destroy();
        }

        charts.priority = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: [
                        '#6b7280', // low - gray
                        '#fbbf24', // medium - yellow
                        '#f97316', // high - orange
                        '#ef4444'  // urgent - red
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function loadPerformanceTrends() {
        const timeRange = document.getElementById('timeRange').value;

        // Response time trend
        fetch(`/admin/api/analytics/response-time-trend?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createResponseTimeChart(data.data);
                }
            });

        // Resolution time trend
        fetch(`/admin/api/analytics/resolution-time-trend?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createResolutionTimeChart(data.data);
                }
            });

        // Satisfaction trend
        fetch(`/admin/api/analytics/satisfaction-trend?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createSatisfactionChart(data.data);
                }
            });
    }

    function createResponseTimeChart(data) {
        const ctx = document.getElementById('responseTimeChart').getContext('2d');

        if (charts.responseTime) {
            charts.responseTime.destroy();
        }

        charts.responseTime = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ _("Hours") }}',
                    data: data.values,
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createResolutionTimeChart(data) {
        const ctx = document.getElementById('resolutionTimeChart').getContext('2d');

        if (charts.resolutionTime) {
            charts.resolutionTime.destroy();
        }

        charts.resolutionTime = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ _("Hours") }}',
                    data: data.values,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createSatisfactionChart(data) {
        const ctx = document.getElementById('satisfactionChart').getContext('2d');

        if (charts.satisfaction) {
            charts.satisfaction.destroy();
        }

        charts.satisfaction = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '{{ _("Rating") }}',
                    data: data.values,
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function loadTopIssues() {
        const timeRange = document.getElementById('timeRange').value;

        fetch(`/admin/api/analytics/top-issues?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderTopIssues(data.issues);
                }
            });
    }

    function renderTopIssues(issues) {
        const tbody = document.getElementById('topIssuesTable');
        tbody.innerHTML = issues.map(issue => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${issue.issue}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${issue.count}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="text-${issue.trend > 0 ? 'red' : issue.trend < 0 ? 'green' : 'gray'}-600">
                    ${issue.trend > 0 ? '↗' : issue.trend < 0 ? '↘' : '→'} ${Math.abs(issue.trend)}%
                </span>
            </td>
        </tr>
    `).join('');
    }

    function loadAgentPerformance() {
        const timeRange = document.getElementById('timeRange').value;

        fetch(`/admin/api/analytics/agent-performance?days=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAgentPerformance(data.agents);
                }
            });
    }

    function renderAgentPerformance(agents) {
        const tbody = document.getElementById('agentPerformanceTable');
        tbody.innerHTML = agents.map(agent => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.resolved}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.avg_time}h</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                    <span class="mr-2">${agent.rating.toFixed(1)}</span>
                    <div class="flex">
                        ${Array.from({ length: 5 }, (_, i) => `
                            <i class="fas fa-star text-${i < Math.floor(agent.rating) ? 'yellow' : 'gray'}-400 text-xs"></i>
                        `).join('')}
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
    }

    function updateChart(chartType, period) {
        // Update button states
        const buttons = document.querySelectorAll(`[onclick*="${chartType}"]`);
        buttons.forEach(btn => {
            btn.className = btn.textContent.toLowerCase().includes(period) ?
                'px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded-md' :
                'px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-md';
        });

        // Reload chart data with new period
        const timeRange = document.getElementById('timeRange').value;

        fetch(`/admin/api/analytics/complaints-trend?days=${timeRange}&period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createComplaintsChart(data.data);
                }
            });
    }

    function exportReport() {
        const timeRange = document.getElementById('timeRange').value;
        window.open(`/admin/api/analytics/export?days=${timeRange}`, '_blank');
    }
</script>
{% endblock %}