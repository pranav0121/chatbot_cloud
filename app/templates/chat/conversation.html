{% extends "base.html" %}

{% block title %}{{ _('Conversation') }} #{{ complaint.id }} - YouCloudPay Devshop Support{% endblock %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-50 overflow-hidden">
    <!-- Chat Header -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <!-- Back Button -->
                <a href="{{ url_for('main.dashboard') }}"
                    class="p-1 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-md">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </a>

                <div class="flex-shrink-0">
                    <div class="h-7 w-7 bg-blue-600 rounded-full flex items-center justify-center">
                        <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div>
                    <h1 class="text-base font-medium text-gray-900">
                        {{ _('Complaint') }} #{{ complaint.id }}
                    </h1>
                    <p class="text-xs text-gray-500">
                        {{ complaint.subject }}
                        {% if complaint.status %}
                        • <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium
                                {% if complaint.status == 'open' %}bg-green-100 text-green-800
                                {% elif complaint.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                {% elif complaint.status == 'resolved' %}bg-blue-100 text-blue-800
                                {% elif complaint.status == 'closed' %}bg-gray-100 text-gray-800
                                {% endif %}">
                            {{ complaint.status.replace('_', ' ').title() }}
                        </span>
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Language Selector -->
                <select id="language-selector"
                    class="text-xs border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="en" {% if current_user.language=='en' %}selected{% endif %}>English</option>
                    <option value="es" {% if current_user.language=='es' %}selected{% endif %}>Español</option>
                    <option value="fr" {% if current_user.language=='fr' %}selected{% endif %}>Français</option>
                    <option value="de" {% if current_user.language=='de' %}selected{% endif %}>Deutsch</option>
                    <option value="pt" {% if current_user.language=='pt' %}selected{% endif %}>Português</option>
                    <option value="it" {% if current_user.language=='it' %}selected{% endif %}>Italiano</option>
                    <option value="zh" {% if current_user.language=='zh' %}selected{% endif %}>中文</option>
                    <option value="ja" {% if current_user.language=='ja' %}selected{% endif %}>日本語</option>
                </select>
                <!-- Connection Status -->
                <div class="flex items-center gap-1">
                    <div id="connection-status" class="h-2 w-2 bg-green-400 rounded-full"></div>
                    <span class="text-xs text-gray-500">{{ _('Connected') }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Messages Container -->
    <div class="flex-1 overflow-hidden">
        <div id="chat-container" class="h-full overflow-y-auto p-2 space-y-2">
            {% if not messages %}
            <!-- No messages yet -->
            <div class="flex items-center justify-center h-32">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">{{ _('No messages yet. Start the conversation!') }}</p>
                </div>
            </div>
            {% else %}
            <!-- Messages -->
            {% for message in messages %}
            <div
                class="flex items-start gap-2 {% if message.sender_type == 'user' and message.user_id == current_user.id %}justify-end{% endif %}">
                {% if message.sender_type != 'user' or message.user_id != current_user.id %}
                <!-- Other person's message (left aligned) -->
                <div class="flex-shrink-0">
                    {% if message.sender_type == 'bot' %}
                    <div class="h-6 w-6 bg-blue-600 rounded-full flex items-center justify-center">
                        <svg class="h-3.5 w-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    {% else %}
                    <div class="h-8 w-8 bg-gray-400 rounded-full flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-2 max-w-md">
                        <p class="text-sm text-gray-900">{{ message.display_content or message.content }}</p>
                        {% if message.attachments %}
                        <div class="mt-2 space-y-1">
                            {% for attachment in message.attachments %}
                            <div class="flex items-center gap-1 text-xs text-blue-600">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                    </path>
                                </svg>
                                <a href="{{ url_for('main.download_file', filename=attachment.filename) }}"
                                    class="hover:underline">{{ attachment.filename }}</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-1 text-xs text-gray-500">
                        {% if message.sender_type == 'bot' %}
                        {{ _('Support Assistant') }}
                        {% elif message.user %}
                        {{ message.user.name }}
                        {% else %}
                        {{ _('System') }}
                        {% endif %}
                        • {{ message.created_at.strftime('%H:%M') }}
                    </div>
                </div>
                {% else %}
                <!-- Current user's message (right aligned) -->
                <div class="flex-1 min-w-0 flex justify-end">
                    <div class="bg-blue-600 text-white rounded-lg shadow-sm p-2 max-w-md">
                        <p class="text-sm">{{ message.display_content or message.content }}</p>
                        {% if message.attachments %}
                        <div class="mt-2 space-y-1">
                            {% for attachment in message.attachments %}
                            <div class="flex items-center gap-1 text-xs text-blue-100">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                    </path>
                                </svg>
                                <a href="{{ url_for('main.download_file', filename=attachment.filename) }}"
                                    class="hover:underline">{{ attachment.filename }}</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="flex-shrink-0 ml-3">
                    <div class="h-8 w-8 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                {% endif %}
            </div>

            {% if not loop.last %}
            <div class="flex justify-center">
                <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    {{ message.created_at.strftime('%H:%M') }}
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}

            <!-- Typing Indicator -->
            <div id="typing-indicator-message" class="flex items-start gap-2" style="display: none;">
                <div class="flex-shrink-0">
                    <div class="h-8 w-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-2">
                        <div class="flex items-center gap-1">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="text-xs text-gray-500 ml-1">{{ _('Assistant is typing...') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Input -->
    <div class="bg-white border-t border-gray-200 px-3 py-2 flex-shrink-0">
        <form id="chat-form" class="flex items-end gap-2"
            action="{{ url_for('chat.send_message', complaint_id=complaint.id) }}" method="POST">
            <div class="flex-1">
                <!-- File Upload -->
                <div id="file-preview" class="mb-1 hidden">
                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-md p-1">
                        <div class="flex items-center gap-1">
                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                </path>
                            </svg>
                            <span id="file-name" class="text-xs text-blue-900"></span>
                        </div>
                        <button type="button" onclick="removeFile()" class="text-blue-600 hover:text-blue-800">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="relative">
                    <textarea id="message-input" name="content" rows="1" placeholder="{{ _('Type your message...') }}"
                        class="block w-full resize-none border border-gray-300 rounded-lg px-3 py-2 pr-12 focus:ring-blue-500 focus:border-blue-500 text-sm"
                        style="min-height: 36px; max-height: 80px;" required></textarea>

                    <!-- Attachment Button -->
                    <div class="absolute right-2 bottom-1.5 flex items-center gap-1">
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)"
                            accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt">
                        <button type="button" onclick="document.getElementById('file-input').click()"
                            class="p-0.5 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Send Button -->
            <button type="submit" id="send-button"
                class="inline-flex items-center justify-center h-9 w-9 bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white rounded-lg transition-colors duration-200">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </form>
    </div>
</div>

<!-- CSS for typing animation -->
<style>
    .typing-dots {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .typing-dot {
        width: 3px;
        height: 3px;
        border-radius: 50%;
        background-color: #9CA3AF;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {

        0%,
        80%,
        100% {
            transform: scale(0);
            opacity: 0.5;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<script>
    // Auto-resize textarea
    document.getElementById('message-input').addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 80) + 'px';
    });

    // Handle form submission
    document.getElementById('chat-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();

        if (!content) return;

        // Show typing indicator
        showTypingIndicator();

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Send message via AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'content': content
            })
        })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                if (data.success) {
                    // Reload the page to show new messages
                    location.reload();
                } else {
                    alert(data.error || 'Failed to send message');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error:', error);
                alert('Failed to send message');
            });

        messageInput.value = '';
        messageInput.style.height = '36px';
    });

    // File handling functions
    function handleFileSelect(input) {
        const file = input.files[0];
        if (file) {
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-preview').classList.remove('hidden');

            // Upload file with CSRF protection
            uploadFile(file);
        }
    }

    function removeFile() {
        document.getElementById('file-input').value = '';
        document.getElementById('file-preview').classList.add('hidden');
    }

    function uploadFile(file) {
        const complaintId = {{ complaint.id }
    };
    const uploadUrl = `/chat/${complaintId}/upload`;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const formData = new FormData();
    formData.append('file', file);

    fetch(uploadUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show the uploaded file
                location.reload();
            } else {
                alert(data.error || 'Failed to upload file');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to upload file');
        });
}

    // Typing indicator functions
    function showTypingIndicator() {
        document.getElementById('typing-indicator-message').style.display = 'flex';
        scrollToBottom();
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator-message').style.display = 'none';
    }

    // Auto-scroll to bottom
    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
    }

    // Language selector
    document.getElementById('language-selector').addEventListener('change', function () {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/api/set-language', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                language: this.value
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    });

    // Scroll to bottom on page load
    window.addEventListener('load', scrollToBottom);
</script>
{% endblock %}