{% extends "base.html" %}

{% block title %}{{ _('Create New Complaint') }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">{{ _('Submit a Complaint') }}</h1>
            <p class="mt-2 text-gray-600">{{ _('We\'re here to help. Please provide details about your issue.') }}</p>
        </div>

        <!-- Form -->
        <div class="bg-white shadow-lg rounded-lg p-8">
            <form id="complaintForm" enctype="multipart/form-data">
                <!-- Subject -->
                <div class="mb-6">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ _('Subject') }} <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="subject" name="subject" required maxlength="200"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ _('Brief description of your issue') }}">
                    <p class="mt-1 text-sm text-gray-500">{{ _('Maximum 200 characters') }}</p>
                </div>

                <!-- Category -->
                <div class="mb-6">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ _('Category') }} <span class="text-red-500">*</span>
                    </label>
                    <select id="category" name="category" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">{{ _('Select a category') }}</option>
                        <option value="technical">{{ _('Technical Support') }}</option>
                        <option value="billing">{{ _('Billing & Payment') }}</option>
                        <option value="account">{{ _('Account Issues') }}</option>
                        <option value="general">{{ _('General Inquiry') }}</option>
                    </select>
                </div>

                <!-- Priority -->
                <div class="mb-6">
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ _('Priority') }} <span class="text-red-500">*</span>
                    </label>
                    <select id="priority" name="priority" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="low">{{ _('Low - General inquiry or feature request') }}</option>
                        <option value="medium" selected>{{ _('Medium - Non-urgent issue affecting functionality') }}
                        </option>
                        <option value="high">{{ _('High - Urgent issue affecting your work') }}</option>
                        <option value="urgent">{{ _('Urgent - Critical issue requiring immediate attention') }}</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ _('Description') }} <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" name="description" required rows="6" maxlength="2000"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ _('Please provide detailed information about your issue, including any error messages and steps you\'ve already taken.') }}"></textarea>
                    <div class="mt-1 flex justify-between">
                        <p class="text-sm text-gray-500">{{ _('Please be as detailed as possible') }}</p>
                        <p class="text-sm text-gray-500"><span id="charCount">0</span>/2000</p>
                    </div>
                </div>

                <!-- File Attachments -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ _('Attachments') }} ({{ _('Optional') }})
                    </label>
                    <div
                        class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload"
                                    class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>{{ _('Upload files') }}</span>
                                    <input id="file-upload" name="attachments" type="file" class="sr-only" multiple
                                        accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.zip">
                                </label>
                                <p class="pl-1">{{ _('or drag and drop') }}</p>
                            </div>
                            <p class="text-xs text-gray-500">{{ _('PNG, JPG, PDF, DOC up to 10MB each') }}</p>
                        </div>
                    </div>

                    <!-- File List -->
                    <div id="fileList" class="mt-4 space-y-2 hidden">
                        <!-- Selected files will appear here -->
                    </div>
                </div>

                <!-- Terms Agreement -->
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="termsAgreement" required
                            class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <span class="ml-2 text-sm text-gray-600">
                            {{ _('I agree that the information provided is accurate and I consent to processing of this
                            data according to our') }}
                            <a href="/privacy" class="text-blue-600 hover:text-blue-800">{{ _('Privacy Policy') }}</a>
                        </span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4">
                    <a href="/dashboard"
                        class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        {{ _('Cancel') }}
                    </a>
                    <button type="submit" id="submitBtn"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span id="submitText">{{ _('Submit Complaint') }}</span>
                        <span id="submitLoader" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>{{ _('Submitting...') }}
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">{{ _('Need Immediate Help?') }}</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>{{ _('For urgent issues, you can also:') }}</p>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            <li>{{ _('Start a live chat from your dashboard') }}</li>
                            <li>{{ _('Check our') }} <a href="/faq" class="font-medium underline">{{ _('FAQ section')
                                    }}</a> {{ _('for common solutions') }}</li>
                            <li>{{ _('Email us directly at support@youcloudpay.com') }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('complaintForm');
        const fileUpload = document.getElementById('file-upload');
        const fileList = document.getElementById('fileList');
        const descriptionTextarea = document.getElementById('description');
        const charCount = document.getElementById('charCount');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');

        let selectedFiles = [];

        // Character counter
        descriptionTextarea.addEventListener('input', function () {
            charCount.textContent = this.value.length;
        });

        // File upload handling
        fileUpload.addEventListener('change', function () {
            handleFiles(this.files);
        });

        // Drag and drop
        const dropZone = fileUpload.parentElement.parentElement.parentElement;

        dropZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            this.classList.add('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            this.classList.remove('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', function (e) {
            e.preventDefault();
            this.classList.remove('border-blue-400', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/zip'];

            for (let file of files) {
                if (file.size > maxSize) {
                    showNotification(`{{ _('File') }} ${file.name} {{ _('is too large. Maximum size is 10MB.') }}`, 'error');
                    continue;
                }

                if (!allowedTypes.includes(file.type)) {
                    showNotification(`{{ _('File type not supported:') }} ${file.name}`, 'error');
                    continue;
                }

                if (selectedFiles.length >= 5) {
                    showNotification('{{ _('Maximum 5 files allowed') }}', 'error');
                    break;
                }

                selectedFiles.push(file);
            }

            updateFileList();
        }

        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                return;
            }

            fileList.classList.remove('hidden');
            fileList.innerHTML = selectedFiles.map((file, index) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-file text-gray-400 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
        }

        window.removeFile = function (index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoader.classList.remove('hidden');

            const formData = new FormData();
            formData.append('subject', document.getElementById('subject').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('priority', document.getElementById('priority').value);
            formData.append('description', document.getElementById('description').value);

            // Add files
            selectedFiles.forEach(file => {
                formData.append('attachments', file);
            });

            fetch('/api/complaints', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        setTimeout(() => {
                            window.location.href = `/complaints/${data.complaint_id}`;
                        }, 2000);
                    } else {
                        throw new Error(data.message || '{{ _("Error submitting complaint") }}');
                    }
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    submitLoader.classList.add('hidden');
                });
        });

        function validateForm() {
            const subject = document.getElementById('subject').value.trim();
            const category = document.getElementById('category').value;
            const priority = document.getElementById('priority').value;
            const description = document.getElementById('description').value.trim();
            const termsAgreed = document.getElementById('termsAgreement').checked;

            if (!subject || !category || !priority || !description || !termsAgreed) {
                showNotification('{{ _("Please fill in all required fields") }}', 'error');
                return false;
            }

            if (subject.length > 200) {
                showNotification('{{ _("Subject is too long") }}', 'error');
                return false;
            }

            if (description.length > 2000) {
                showNotification('{{ _("Description is too long") }}', 'error');
                return false;
            }

            return true;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white shadow-lg max-w-sm`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    });
</script>
{% endblock %}